var through = require('through2');
var gutil = require('gulp-util');
var PluginError = gutil.PluginError;
var PLUGIN_NAME = 'del-gulpsass-blank-lines';

/* 将二进制转换成正常的文本 */
function buffer2String(text){
    return text.toString('utf8');
}
/* 去掉多余的空格行并返回文本 */
function delBlankLines(txt){
    // 匹配两个换行符，并替换为一个换行符
    return txt.replace(/\n{2}/g, '\n');
}
/* 主函数 */
function delGulpSassBlankLines() {
    // 创建一个 stream 通道，以让每个文件通过
    var stream = through.obj(function(file, enc, cb) {
        // Stream
        if (file.isStream()) {
            this.emit('error', new PluginError(PLUGIN_NAME, 'Streams are not supported!'));
            return cb();
        }
        // Buffer
        if (file.isBuffer()) {
            // 将二进制转换成正常的文本
            var txt = buffer2String(file.contents);
            // 将正常的文本去空行后重新转换成二进制
            file.contents = new Buffer(delBlankLines(txt));
        }
        this.push(file); // 确保文件进入下一个 gulp 插件
        cb();             // 告诉 stream 引擎，我们已经处理完了这个文件
    });
    return stream;
}

module.exports = delGulpSassBlankLines;
